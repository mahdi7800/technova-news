<?php// RECOVERY PASSWORDadd_action('wp_ajax_nopriv_tnw_recover_email','tnw_recover_email');function tnw_recover_email() {	if (!isset($_POST['nonce']) && !wp_verify_nonce($_POST['nonce'])){		die('access deind');	}	$email = sanitize_text_field($_POST['email']);	tnw_recovery_password_validate($email);	$recovery_link = TNW_Token::tnw_create_token($email);	wp_tnw_token_create_to_db($email,$recovery_link);	wp_tnw_recaver_password_email($email,$recovery_link);}function tnw_recovery_password_validate($email) {	if (empty($email)){		wp_send_json(['error'=>true,'message'=>'لطفا ایمیل خود را وارد کنید'],403);	}elseif(!is_email($email)){		wp_send_json(['error'=>true,'message'=>'لطفا ایمیل معتبر وراد کنید'],403);	}elseif(!email_exists( $email ))		wp_send_json( [ 'error' => true, 'message' => 'این ایمیل در سیستم ثبت نشده است!' ], 403 );}function  wp_tnw_recaver_password_email($email,$recovery_link) {	$headers = ['Content-Type: text/html; charset=UTF-8'];	$send_mail = wp_mail(		$email,		'باز یابی کلمه عبور ',		$recovery_link.'باز یابی کلمه عبور :  لینک ',		$headers	);	if ($send_mail){		wp_tnw_token_create_to_db($email,$recovery_link);		wp_send_json(['success'=>true , 'message'=>'لینک بازیابی کلمه عبور ارسال شد!'],200);	}else{		// اگر ارسال ایمیل کار نکند، لینک بازیابی را مستقیماً در خروجی ارسال کنید		wp_tnw_token_create_to_db($email, $recovery_link);		wp_send_json([			'success' => true,			'message' => 'ارسال ایمیل کار نمی‌کند، اما لینک بازیابی تولید شد.',			'recovery_link' => $recovery_link		], 200);	}}//CHANGE PASSWORDadd_action('wp_ajax_nopriv_tnw_change_password','tnw_change_password');function tnw_change_password() {	if (!isset($_POST['nonce']) && !wp_verify_nonce($_POST['nonce'])){		die('access deind');	}	$new_password = sanitize_text_field($_POST['new_password']);	$repeat_password = sanitize_text_field($_POST['repeat_password']);	$token = sanitize_text_field($_POST['token']);	tnw_change_password_validate($new_password,$repeat_password);    $user_id = wp_tnw_check_token_get_usr_id($token);	if ( ! $user_id ) {		wp_send_json( [ 'error' => true, 'message' => 'توکن نامعتبر است یا کاربر یافت نشد!' ], 403 );		exit;	}	wp_set_password($new_password,$user_id);	wp_tnw_delete_recover_password($token);	wp_send_json( [ 'success' => true, 'message' => 'کلمه عبور با موفقیت تغییر کرد!' , 'redirect_url' => site_url() ], 200 );    exit();}function tnw_change_password_validate($new_password,$repeat_password) {	if (empty($new_password) && empty($repeat_password)){		wp_send_json(['error'=>true,'message'=>'پر کردن تمام فیلد ها الزامی است!'],403);	}	if (empty($new_password)){		wp_send_json(['error'=>true,'message'=>'پرکردن رمز عبور جدید الزامی است!'],403);	}elseif(empty($repeat_password)){		wp_send_json(['error'=>true,'message'=>'پرکردن تکرار رمز عبور جدید الزامی است!'],403);	}	if (!preg_match('/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/',$new_password)){		wp_send_json(['error' => true, 'message' => 'کلمه عبور شما باید شامل 8 کارکتر، یک عدد، یک کارکتر ویژه و یک حرف بزرگ باشد!'], 403);	}	if ($new_password !== $repeat_password){		wp_send_json(['error' => true, 'message' => 'کلمه عبور و تکرار آن مطابقت ندارد!'], 403);	}}